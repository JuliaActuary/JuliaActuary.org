<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>JuliaActuary – Bayesian vs Limited Fluctuation Experience Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<link rel="stylesheet" href="../../assets/highlight/styles/github.min.css">
<script src="../../assets/highlight/highlight.min.js"></script>
<script src="../../assets/highlight/languages/julia.min.js"></script>
<script src="../../assets/highlight/languages/julia-repl.min.js"></script>
<script src="../../assets/highlight/languages/python.min.js"></script>
<script src="../../assets/highlight/languages/r.min.js"></script>
<script>hljs.highlightAll();</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../assets/logos/android-chrome-512x512.png" alt="JuliaActuary Logo" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">JuliaActuary</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../packages.html"> 
<span class="menu-text">Packages</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../learn.html"> 
<span class="menu-text">Learn</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../examples.html"> 
<span class="menu-text">Examples</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../benchmarks.html"> 
<span class="menu-text">Benchmarks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/JuliaActuary"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Bayesian vs Limited Fluctuation Experience Analysis</h1>
  <div class="quarto-categories">
    <div class="quarto-category">modeling</div>
    <div class="quarto-category">statistics</div>
    <div class="quarto-category">experience-analysis</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Alternate title: Why actuaries should cease to care about the number 1082.</p>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This notebook briefly discusses two approaches to experience analysis (rate setting). One traditional method, Limited Fluctuation Credibility (LFC), has been around for a very long time although was never intended to be the most accurate predictive method. However, many actuaries still discuss the notion of “full” or “partially” credible indicating a reliance on the LFC concepts.</p>
<p>The Bayesian approach uses explicit assumptions about the statistical relationships and all data given to the model to make inferences. Small datasets lead to greater uncertainty, while larger datasets never reach a point that could be considered “fully credible”, although the posterior density may narrow considerably.</p>
<p>This notebook argues that the Bayesian approach is superior to the LFC heuristics and should be adopted more widely in actuarial practice.</p>
<p>The example will use an auto-claims dataset and will use the first two years of experience to predict the third.</p>
<div id="e3c132d9" class="cell" data-execution_count="1">
<pre class="julia cell-code"><code>using CSV
using DataFramesMeta
using Distributions
using Turing
using MCMCChains
using DataFrames
using Logging; Logging.disable_logging(Logging.Warn);
using StatsFuns
using StatisticalRethinking
using CairoMakie</code></pre>
</div>
</section>
<section id="limited-fluctuation-credibility" class="level2">
<h2 class="anchored" data-anchor-id="limited-fluctuation-credibility">Limited Fluctuation Credibility</h2>
<blockquote class="blockquote">
<p>The Limited Fluctuation Method was so named because it allowed premiums to fluctuate from year to year based on experience, while limiting those fluctuations by giving less than full credibility to premiums based on limited data. In contrast, setting premium rates by giving full credibility to recent experience could be called the Full Fluctuation Method. While every credibility method serves to limit fluctuations, this method acquired its name because it was the first. The Limited Fluctuation Method, also known as Classical Credibility, is the most widely-used credibility method because it can be relatively simple to apply. Outside North America, this method is sometimes referred to as American Credibility.</p>
</blockquote>
<p>Quoted from <a href="https://www.soa.org/globalassets/assets/files/resources/tables-calcs-tools/credibility-methods-life-health-pensions.pdf">Atkinson, 2019</a>.</p>
<section id="formulas" class="level3">
<h3 class="anchored" data-anchor-id="formulas">Formulas</h3>
<p>The Limited Fluctuation Method components: a credibility weight, <span class="math display">\[Z\]</span>, an Observed Rate, and a Prior Rate.</p>
<p><span class="math display">\[
\text{Credibility-Weighted Rate} = Z × \text{Observed Rate} + (1 – Z) × \text{Prior Rate}
\]</span></p>
<p>With probability equal to <span class="math inline">\(LC_p\)</span> that the Observed Rate does not differ from the true rate by more than <span class="math inline">\(LC_r\)</span>.</p>
<div id="7f26fb01" class="cell" data-execution_count="2">
<pre class="julia cell-code"><code>LC_p = 0.9
LC_r  = 0.05</code></pre>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>0.05</code></pre>
</div>
</div>
<p><span class="math display">\[
\text{Claims for full credibility} = \left(\frac{\text{Z-Score}}{\text{ratio}}\right)^{2}
\]</span></p>
<div id="17ef1a75" class="cell" data-execution_count="3">
<pre class="julia cell-code"><code>LC_full_credibility = round(Int, (quantile(Normal(), 1 - (1 - LC_p) / 2) / LC_r)^2)</code></pre>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>1082</code></pre>
</div>
</div>
<p>Using the inputs above, we have a z-score corresponding to 0.9 of 1.6448536269514717, so: ( 1.6448536269514717 ÷ 0.05)² ≈ 1082. ““”</p>
<p><a href="https://www.soa.org/globalassets/assets/files/resources/tables-calcs-tools/credibility-methods-life-health-pensions.pdf">Atkinson</a> goes on to nicely summarize the square root method which assigns full credibility, <span class="math display">\[Z = 1\]</span>, when the number of actual claims equals or exceeds the full credibility threshold of $LC_full_credibility claims.</p>
<p>When the number of claims is less than full credibility:</p>
<p><span class="math display">\[
Z = \sqrt{\frac{\text{no. claims in group}}{\text{no. claims full credibility}}}
\]</span></p>
</section>
<section id="issues-with-limited-fluctuation" class="level3">
<h3 class="anchored" data-anchor-id="issues-with-limited-fluctuation">Issues with Limited Fluctuation</h3>
<ul>
<li>Ignores available information:
<ul>
<li>Why does our <span class="math inline">\(Z\)</span> not vary by exposures?</li>
<li>No mechanism for a related group to inform the credibility of another</li>
<li>Results in a single point estimate with only approximate measure of estimate uncertainty</li>
</ul></li>
<li>Relies on a number of assumptions/constraints:
<ul>
<li>That aggregated claims can be approximated by a normal distribution</li>
<li>The thresholds of $LC_p and $LC_r are arbitrary (e.g.&nbsp;all of the same arguments against p-value thresholds can apply to this approach) ““”</li>
</ul></li>
</ul>
</section>
</section>
<section id="bayesian-approach" class="level2">
<h2 class="anchored" data-anchor-id="bayesian-approach">Bayesian Approach</h2>
<p>Bayes’ formula of updating the posterior probability conditioned on the observed data:</p>
<p><span class="math display">\[
P(A\mid B) = \frac{P(B \mid A) P(A)}{P(B)}
\]</span></p>
<p>This is well known to most actuaries… but generally not applied frequently in practice!</p>
<p>The issue is that once the probability distributions and data become non-trivial, the formula becomes analytically intractable. Work over the last several decades has set the stage for addressing these situations by developing algorithms that let you sample the Bayesian posterior, even if you can’t analytically say what that is.</p>
<p>A full overview is beyond the scope of this notebook, which is simply to demonstrate that Limited Fluctuation Credibility is of questionable use in practice and that superior tools exist. For references on modern Bayesian statistics, see the end notes.</p>
<p>Note that this is describing a <em>different</em>, more first-principles approach than the the Buhlman Bayesian approach, which attempts to simply relate group experience to population experience. The Bayesian approach described here is much more general and extensible.</p>
<section id="the-formulation" class="level3">
<h3 class="anchored" data-anchor-id="the-formulation">The formulation</h3>
<p>Contrary to Limited Fluctuation, the Bayesian approach forces one to be explicit about the presumed structure of the probability model. The flexibility of the statistical model allows one to incorporate actuarial judgement in a quantitative way. For example, in this example we assume that the claims experience of each group informs a global (hyperparameter) prior distribution which we could use as a starting point for a new type of observation. More on this once the data is introduced.</p>
</section>
</section>
<section id="sample-claims-prediction" class="level2">
<h2 class="anchored" data-anchor-id="sample-claims-prediction">Sample Claims Prediction</h2>
<p>The data comes from an <a href="https://www.kaggle.com/competitions/ClaimPredictionChallenge/data?select=dictionary.html">Allstate auto-claims data via Kaggle</a>. It contains exposure level information about predictor variable and claim amounts for calendar years 2005-2007.</p>
<p>For simplicity, we will focus on the narrow objective of estimating the claims rate at the level of automobile make and model. We will use the years 2005 and 2006 as the training data set and then 2007 to evaluate the predictive model.</p>
<p>The original data is over 13 million rows, we will load an already summarized CSV and split it into <code>train</code> and <code>test</code> sets based on the <code>Calendar_Year</code>.</p>
<div id="4b64554a" class="cell" data-execution_count="4">
<pre class="julia cell-code"><code>train,test = let
    pth = download("https://raw.githubusercontent.com/JuliaActuary/Learn/master/data/condensed_auto_claims.csv")
    df = CSV.read(pth,DataFrame,normalizenames=true)
    df.p_observed = df.claims ./ df.n
    

    train = df[df.Calendar_Year .&lt; 2007,:]
    test  = df[df.Calendar_Year .== 2007,:]

    train, test
    
end</code></pre>
<div class="cell-output cell-output-display" data-execution_count="6">
<div class="ansi-escaped-output">
<pre>(<span class="ansi-bold">2413×5 DataFrame</span>
<span class="ansi-bold">  Row </span>│<span class="ansi-bold"> Calendar_Year </span><span class="ansi-bold"> Blind_Model </span><span class="ansi-bold"> n     </span><span class="ansi-bold"> claims </span><span class="ansi-bold"> p_observed </span>
      │<span class="ansi-bright-black-fg"> Int64         </span><span class="ansi-bright-black-fg"> String7     </span><span class="ansi-bright-black-fg"> Int64 </span><span class="ansi-bright-black-fg"> Int64  </span><span class="ansi-bright-black-fg"> Float64    </span>
──────┼───────────────────────────────────────────────────────
    1 │          2005  K.78          6132      41  0.00668624
    2 │          2005  Q.22         35141     270  0.00768333
    3 │          2005  AR.41        18719     174  0.00929537
    4 │          2006  AR.41        18868     196  0.010388
    5 │          2005  D.20          4573      27  0.00590422
    6 │          2006  D.20          5446      23  0.00422328
    7 │          2006  AJ.129       50803     342  0.00673189
    8 │          2006  AQ.17        44018     263  0.00597483
    9 │          2005  AQ.17        42684     278  0.00651298
   10 │          2005  BW.3         37903     215  0.00567237
   11 │          2006  BW.3         37752     195  0.00516529
  ⋮   │       ⋮             ⋮         ⋮      ⋮         ⋮
 2404 │          2005  CA.5             1       0  0.0
 2405 │          2005  J.5              1       0  0.0
 2406 │          2006  J.5              1       0  0.0
 2407 │          2005  CB.8             1       0  0.0
 2408 │          2005  AQ.1             1       0  0.0
 2409 │          2005  AJ.96            1       0  0.0
 2410 │          2005  AJ.51            1       0  0.0
 2411 │          2006  AJ.51            1       0  0.0
 2412 │          2005  BQ.6             1       0  0.0
 2413 │          2006  BQ.6             1       0  0.0
<span class="ansi-cyan-fg">                                             2392 rows omitted</span>, <span class="ansi-bold">1289×5 DataFrame</span>
<span class="ansi-bold">  Row </span>│<span class="ansi-bold"> Calendar_Year </span><span class="ansi-bold"> Blind_Model </span><span class="ansi-bold"> n      </span><span class="ansi-bold"> claims </span><span class="ansi-bold"> p_observed </span>
      │<span class="ansi-bright-black-fg"> Int64         </span><span class="ansi-bright-black-fg"> String7     </span><span class="ansi-bright-black-fg"> Int64  </span><span class="ansi-bright-black-fg"> Int64  </span><span class="ansi-bright-black-fg"> Float64    </span>
──────┼────────────────────────────────────────────────────────
    1 │          2007  X.45          99368     789  0.00794018
    2 │          2007  Y.29          55783     435  0.00779807
    3 │          2007  P.18           4923      46  0.0093439
    4 │          2007  X.40           5573      22  0.0039476
    5 │          2007  Y.42          25800     168  0.00651163
    6 │          2007  AH.164        12564      88  0.00700414
    7 │          2007  AH.119         4251      26  0.00611621
    8 │          2007  W.3            7680      60  0.0078125
    9 │          2007  BW.107        10897      53  0.00486372
   10 │          2007  BW.79          6938      35  0.00504468
   11 │          2007  AU.58         53424     508  0.00950883
  ⋮   │       ⋮             ⋮         ⋮       ⋮         ⋮
 1280 │          2007  BW.123            1       0  0.0
 1281 │          2007  V.8               1       0  0.0
 1282 │          2007  Z.18              1       0  0.0
 1283 │          2007  X.14              2       0  0.0
 1284 │          2007  AM.7              1       0  0.0
 1285 │          2007  BU.37             1       0  0.0
 1286 │          2007  AE.6              2       0  0.0
 1287 │          2007  CB.6              1       0  0.0
 1288 │          2007  BU.32             1       0  0.0
 1289 │          2007  CA.5              1       0  0.0
<span class="ansi-cyan-fg">                                              1268 rows omitted</span>)</pre>
</div>
</div>
</div>
<section id="discussion-of-bayesian-model" class="level3">
<h3 class="anchored" data-anchor-id="discussion-of-bayesian-model">Discussion of Bayesian model</h3>
<p>Each group (make and model combination) has an expected claim rate <span class="math inline">\(μ_i\)</span>, which is informed by the global hyperparameter <span class="math inline">\(μ\)</span> and variance <span class="math inline">\(\sigma^2\)</span>. Then, the observed claims by group are assumed to be distributed according to a <a href="https://juliaactuary.org/tutorials/poissonbinomial/">Poisson distribution</a>.</p>
<p>A complete overview of modern Bayesian models is beyond the scope of this notebook, but a few key points:</p>
<ul>
<li>We are forced with the Bayesian approach to be explicit about the assumptions (versus all of the implicit assumptions of alternative techniques like LF)</li>
<li>We set <em>priors</em> which are the assumed distribution of model parameters before “learning” from the observations. With enough data, it can result in a posterior that the prior was very skeptical of beforehad.</li>
<li>With the volume of data in the training set, the priors we select here are not that important. Some comments on why they were chosen though:
<ul>
<li>The rate of claims is linked with a <em>logistic</em> function, which looks like an integral sign of sorts. <code>logistic(0.0)</code> equals <code>0.5</code> while very negative inputs approach <code>0.0</code> and positive numbers approach <code>1.0</code>. We do this so that the rate of claims is always constrained in the range <span class="math inline">\((0,1)\)</span></li>
<li><code>μ \sim Normal(-2,4)</code> says that we expect the population of auto claims rate to be less than 0.5 (`logistic(-2) ≈ .12) but very wide range of possible values given the wide standard deviation.</li>
<li><code>σ \sim Exponential(0.25)</code> says that we expect the standard devation of an individual group to be positive, but not super wide.</li>
<li><code>μ_i \sim Normal(μ,σ)</code> is the actual prior for each group’s rate of claim and is informed by the above hyperparameters.</li>
</ul></li>
<li><code>@model</code> is a Turing.jl macro which enables interpreting the nice <code>~</code> syntax, which makes the Julia code look very similar to the traditional mathematical notation.</li>
<li>Note the use of broadcasting with the dot syntax (e.g.&nbsp;the <code>.</code> in <code>.~</code>). This tells Julia to vectorize and fuse the computation.
<ul>
<li><code>data.claims .~ Poisson.(data.n .* logistic.(μ_i))</code> means “each value in <code>data.claims</code> is a random outcome (<code>.~</code>) distributed accroding to a corresponding Poisson distribution with <code>\lambda =n \times \text{logistic}(\mu_i)</code> where <code>text{logistic}(\mu_i)</code> is the average claims rate for each group.</li>
</ul></li>
</ul>
<div id="51be1111" class="cell" data-execution_count="5">
<pre class="julia cell-code"><code>@model function model_poisson(data)
    # hyperparameter that informs the prior for each group
    μ ~ Normal(-2,4) 
    σ ~ Exponential(0.25)

    # the random variable representing the average claim rate for each group
    # filldist creates a set of random variable without needing to list out each one
    μ_i ~ filldist(Normal(μ,σ),length(unique(data.Blind_Model)))

    # use the poisson appproximation to the binomial claim outcome with a 
    # logisitc link function to keep the probability between 0 and 1
    data.claims .~ Poisson.(data.n .* logistic.(μ_i))
end</code></pre>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>model_poisson (generic function with 2 methods)</code></pre>
</div>
</div>
<p>Here’s what the prior distribution of claims looks like… and peeking ahead to what the posterior for a single group of claims looks like. See how even though our posterior was very wide (favoring small claims rates), it was dominated by the data to create a very narrow posterior average claims rate.</p>
<p>The model is combined with the data and <a href="https://turing.ml/stable/">Turing.jl</a> is used to computationally arrive at the posterior distribution for the parameters in the statistical model, <span class="math inline">\(\mu\)</span>, <span class="math inline">\(\mu_i\)</span>, and <span class="math inline">\(\sigma\)</span>.</p>
<div id="10e27ec2" class="cell" data-execution_count="6">
<pre class="julia cell-code"><code>mp = let
    # combine the different years in the training set 
    condensed = @chain train begin
        groupby(:Blind_Model)
        @combine begin
            :n = sum(:n)
            :claims = sum(:claims)
        end
    end
    model_poisson(condensed);
end</code></pre>
<div class="cell-output cell-output-display" data-execution_count="8">
<div class="ansi-escaped-output">
<pre>DynamicPPL.Model{typeof(model_poisson), (:data,), (), (), Tuple{DataFrame}, Tuple{}, DynamicPPL.DefaultContext}(model_poisson, (data = <span class="ansi-bold">1238×3 DataFrame</span>
<span class="ansi-bold">  Row </span>│<span class="ansi-bold"> Blind_Model </span><span class="ansi-bold"> n      </span><span class="ansi-bold"> claims </span>
      │<span class="ansi-bright-black-fg"> String7     </span><span class="ansi-bright-black-fg"> Int64  </span><span class="ansi-bright-black-fg"> Int64  </span>
──────┼─────────────────────────────
    1 │ K.78          14058      94
    2 │ Q.22          71401     532
    3 │ AR.41         37587     370
    4 │ D.20          10019      50
    5 │ AJ.129       100824     693
    6 │ AQ.17         86702     541
    7 │ BW.3          75655     410
    8 │ BW.167        42737     294
    9 │ Y.9           92206     755
   10 │ BH.29         15795     162
   11 │ BW.49         27811     156
  ⋮   │      ⋮         ⋮       ⋮
 1229 │ AM.7              2       0
 1230 │ AE.6              3       0
 1231 │ BU.32             2       0
 1232 │ BG.8              1       0
 1233 │ CA.5              2       0
 1234 │ J.5               2       0
 1235 │ AQ.1              1       0
 1236 │ AJ.96             1       0
 1237 │ AJ.51             2       0
 1238 │ BQ.6              2       0
<span class="ansi-cyan-fg">                   1217 rows omitted</span>,), NamedTuple(), DynamicPPL.DefaultContext())</pre>
</div>
</div>
</div>
</section>
<section id="bayesian-posterior-sampling" class="level3">
<h3 class="anchored" data-anchor-id="bayesian-posterior-sampling">Bayesian Posterior Sampling</h3>
<p>Here’s where recent advances in algorithms and computing power make Bayesian analyis possible. We can’t analytically compute the posterior distribution, but we can genererate <em>samples</em> from the posterior such that the frequency of the sampled result appears in proportion to the true posterior density. This uses a technique called <a href="https://en.wikipedia.org/wiki/Markov_chain_Monte_Carlo">Markov Chain Monte Carlo</a>, abbreviated MCMC. There are different algorithms in this family, and we will use one called the No-U-Turn Sampler (NUTS for short).</p>
<p>The result of the <code>sample</code> function is a set of data containing data that is generated in proportion to the posterior distributions and we will use this data to make predictions and understand the distribution of our parameters.</p>
<p>Run the chain:</p>
<div id="0e801164" class="cell" data-execution_count="7">
<pre class="julia cell-code"><code>cp = sample(mp, NUTS(), 500) # this is the line that runs the MCMC sampler

# ╔═╡ 6b5d2186-78ac-48ae-8529-e0dcd51d0b00
let 
    # sample from the priors before learning from any data
    ch_prior = sample(mp,Prior(),1500)
    
    f = Figure()
    ax = Axis(f[1,1],title="Prior distribution of expected claims rate for a group")
    μ = vec(ch_prior["μ_i[1]"].data)
    hist!(ax,logistic.(μ);bins=50)
    ax2 = Axis(f[2,1],title="Posterior distribution of expected claims rate for a group")
    μ = vec(cp["μ_i[1]"].data)
    hist!(ax2,logistic.(μ);bins=50)
    linkxaxes!(ax,ax2)
    f
end</code></pre>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-8-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visualizing-the-posterior-density" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-the-posterior-density">Visualizing the Posterior Density</h3>
<p>This is a plot of the posterior density for all of the many, many <span class="math inline">\(\mu\)</span> parameters in our model. The black line shows the distribution which comes from our hyperparameters μ and σ. In the event of coming across a new group of interest (in our case, a new make of car), this is the prior distribution for the expected claims rate. The model has learned this from the data itself, and serves to regularize predictions.</p>
<div id="52eb40d7" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Utilitiy Function to Plot the Posterior</summary>
<pre class="julia cell-code"><code>"""
    dplot(chain,parameter_string)

plot the posterior density for model parameters matching the given string.
"""
function dplot(ch,param_string)
    f = Figure()
    ax = Axis(f[1, 1])

    # plot each group posterior
   for (ind, param) in enumerate(ch.name_map.parameters)
        if contains(string(param),param_string)
            v = vec(getindex(ch, param).data)
            density!(ax,logistic.(v), color = (:red, 0.0),
    strokecolor = (:red,0.3), strokewidth = 1, strokearound = false, label="Individual group posterior")
        end
   end
    
    # Plot hyperparameters
    hyper_mean = mean(getindex(ch, :μ).data)
    hyper_sigma = mean(getindex(ch, :σ).data)
    d = density!(ax,logistic.(rand(Normal(hyper_mean,hyper_sigma),1000)),color = (:black, 0.),
    strokecolor = (:black,0.3), strokewidth = 3, strokearound = false,label="Hyper-parameter distribution")

    
    xlims!(0.0,0.03)
    hideydecorations!(ax)
    axislegend(ax,unique=true)
    f
end

dplot(cp, "μ")</code></pre>
</details>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-9-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="predictions-and-results" class="level2">
<h2 class="anchored" data-anchor-id="predictions-and-results">Predictions and Results</h2>
<p>Here we compare four predictive models:</p>
<ol type="1">
<li>Naive, where the predicted rate for the 2007 year is the average of each groups’ for 2005-2006</li>
<li>Limited Fluctuation Overall, where the “prior” in the LFC formula is the overall mean claim rate for 2005-2006</li>
<li>Limited Fluctuation Year-by-Year where the “prior” in the LFC formula is the claim rate for the ith group in 2005 and updated using 2006 claim rates.</li>
<li>Bayesian approach where the predicted claim rate is based on the bayesian model discussed above.</li>
</ol>
<section id="predictions" class="level3">
<h3 class="anchored" data-anchor-id="predictions">Predictions</h3>
</section>
<section id="bayesian-approach-has-lower-error" class="level3">
<h3 class="anchored" data-anchor-id="bayesian-approach-has-lower-error">Bayesian approach has lower error</h3>
<p>Looking at the accumulated absolute error, the bayesian approach has about 16% lower error than the Limited Fluctuation approaches.</p>
</section>
<section id="total-actual-to-expected" class="level3">
<h3 class="anchored" data-anchor-id="total-actual-to-expected">Total Actual to Expected</h3>
<p>Here, offsetting errors happen to make the naive and LF year-by-year (the latter is a good proxy for the former) such that their total A/E is better than the Bayesian approach.</p>
<p>Given the lower error of the Bayesian approach, one would expect that over multiple years that it would produce more accurate predictions than the alternative methods.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>This notebook shows that the Bayesian approach results in claims predictions with less total predictive error than the limited fluctuation method.</p>
<section id="further-thoughts" class="level3">
<h3 class="anchored" data-anchor-id="further-thoughts">Further thoughts</h3>
<p>The Bayesian approach could be extended to improve its accuracy even further:</p>
<ul>
<li>Using vehicle make data to add more hierarchical structure to the statistical model. For example, one may observe that Porsches experience crashes at a higher rate than Volvos. LFC cannot embed that sort of overlapping hierarchy into its framework.</li>
<li>The Bayesian hyperparameter provides a framework to think about “unseen” make-model combinations</li>
</ul>
</section>
<section id="downsides-to-the-bayesian-approach" class="level3">
<h3 class="anchored" data-anchor-id="downsides-to-the-bayesian-approach">Downsides to the Bayesian approach</h3>
<ul>
<li>Computationally intensive. Complex <code>@models</code> can take very long time to run (many hours), compared to relatively quick frequentest methods like maximum likelihood estimation.</li>
</ul>
</section>
<section id="further-reading" class="level3">
<h3 class="anchored" data-anchor-id="further-reading">Further Reading</h3>
<p>If this notebook has piqued your interest in Bayesian techniques, the following books are recommended learning resources (from easiest to most difficult):</p>
<ul>
<li>Statistical Rethinking
<ul>
<li>See also <a href="https://github.com/StatisticalRethinkingJulia/StatisticalRethinking.jl">StatisticalRethinking.jl</a> for Julia implementations of all of the book’s code and utility functions</li>
</ul></li>
<li>Bayes Rules!</li>
<li>Bayeisan Data Analysis</li>
</ul>
</section>
</section>
<section id="appendices" class="level2">
<h2 class="anchored" data-anchor-id="appendices">Appendices</h2>
<p>Additional legwork to get the alternate limited fluctuation approach data:</p>
<div id="ce5ad7d5" class="cell" data-execution_count="9">
<pre class="julia cell-code"><code># An alternate approach to LFC where the first year becomes the prior, adjusted by data from the seonc year.
LF2 = let 
    # split dataset by year and recombine
    df2005 = @subset(train,:Calendar_Year .== 2005)
    df2006 = @subset(train,:Calendar_Year .== 2006)
    df = outerjoin(df2005,df2006,on=:Blind_Model,renamecols= "_2005" =&gt; "_2006")

    # use 2005 actuals as LFC prior, and the overall mean if model is missing
    μ_2005 = sum(skipmissing(df.claims_2005)) / sum(skipmissing(df.n_2005))
    df.assumed = coalesce.(df.p_observed_2005,μ_2005)
    
    df.LF2_Z = min.(1, .√(coalesce.(df.claims_2006,0.) ./ LC_full_credibility))
    df.LF2_μ = let Z = df.LF2_Z
        # use the 2005 mean if the model not observed in 2006
        Z .* coalesce.(df.p_observed_2006,μ_2005) .+ (1 .- Z) .* df.assumed
    end
    df
end

claims_summary_posterior = let
    # combine the dataset by model
    df = @chain train begin
        groupby(:Blind_Model)
        @combine begin
            :n = sum(:n)
            :claims = sum(:claims)
        end
    end
    pop_μ = sum(df.claims) / sum(df.n)
    df[!,:pop_μ] .= pop_μ

    ## Bayesian prediction
    # get the mean of the posterior estimate for the ith model group
    means = map(1:length(unique(df.Blind_Model))) do i
        d = logistic.(getindex(cp, Symbol("μ_i[$i]")).data)
        (est = mean(d), se=std(d))
    end

    df.p_observed = df.claims ./ df.n
    df.bayes_μ = [x.est for x in means]
    df.bayes_se = [x.se for x in means]

    ## Limited Fluctuation (square root rule)
    # using overall population mean
    # using the square-root rule
    df.LF_Z = min.(1, .√(df.claims ./ LC_full_credibility))
    df.LF_μ = let Z = df.LF_Z
        Z .* (df.p_observed) .+ (1 .- Z) .* pop_μ
    end

    ## Limited Fluctuation 
    # using the first year as the prior, 2nd year as new data
    # using some additional procesing to get the LF2 dataframe, see appendix
    df2005 = @subset(train, :Calendar_Year .== 2005)
    dict2005 = Dict(
        model =&gt; rate 
        for (model, rate) in zip(df2005.Blind_Model,df2005.p_observed)
    )
    
    df = leftjoin(df,LF2[:,[:Blind_Model,:LF2_μ]],on=:Blind_Model,)
    
    df = innerjoin(df,test;on=:Blind_Model,renamecols= "_train" =&gt; "_test")

    # predictions on the test set using the predictive rates time exposures
    df.pred_bayes = df.n_test .* df.bayes_μ_train
    df.pred_LF = df.n_test .* df.LF_μ_train
    df.pred_LF2 = df.n_test .* df.LF2_μ_train
    df.pred_naive = df.n_test .* df.p_observed_train

    sort!(df,:n_train,rev=true)
end</code></pre>
<div class="cell-output cell-output-display" data-execution_count="11">
<div><div style="float: left;"><span>1224×18 DataFrame</span></div><div style="float: right;"><span style="font-style: italic;">1199 rows omitted</span></div><div style="clear: both;"></div></div><div class="data-frame" style="overflow-x: scroll;">
<table class="data-frame caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;">Row</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Blind_Model</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">n_train</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">claims_train</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">pop_μ_train</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">p_observed_train</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">bayes_μ_train</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">bayes_se_train</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">LF_Z_train</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">LF_μ_train</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">LF2_μ_train</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Calendar_Year_test</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">n_test</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">claims_test</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">p_observed_test</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">pred_bayes</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">pred_LF</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">pred_LF2</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">pred_naive</th>
</tr>
<tr class="odd subheader headerLastRow">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String7">String7</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Union{Missing, Float64}">Float64?</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1</td>
<td style="text-align: left;">K.7</td>
<td style="text-align: right;">382210</td>
<td style="text-align: right;">3365</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.00880406</td>
<td style="text-align: right;">0.00878409</td>
<td style="text-align: right;">0.000146998</td>
<td style="text-align: right;">1.0</td>
<td style="text-align: right;">0.00880406</td>
<td style="text-align: right;">0.00853456</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">215223</td>
<td style="text-align: right;">1798</td>
<td style="text-align: right;">0.00835413</td>
<td style="text-align: right;">1890.54</td>
<td style="text-align: right;">1894.84</td>
<td style="text-align: right;">1836.83</td>
<td style="text-align: right;">1894.84</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">2</td>
<td style="text-align: left;">X.45</td>
<td style="text-align: right;">192591</td>
<td style="text-align: right;">1542</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0080066</td>
<td style="text-align: right;">0.00798345</td>
<td style="text-align: right;">0.000192489</td>
<td style="text-align: right;">1.0</td>
<td style="text-align: right;">0.0080066</td>
<td style="text-align: right;">0.00801192</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">99368</td>
<td style="text-align: right;">789</td>
<td style="text-align: right;">0.00794018</td>
<td style="text-align: right;">793.3</td>
<td style="text-align: right;">795.6</td>
<td style="text-align: right;">796.129</td>
<td style="text-align: right;">795.6</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">3</td>
<td style="text-align: left;">AU.14</td>
<td style="text-align: right;">188702</td>
<td style="text-align: right;">1687</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.00894002</td>
<td style="text-align: right;">0.00890238</td>
<td style="text-align: right;">0.000223507</td>
<td style="text-align: right;">1.0</td>
<td style="text-align: right;">0.00894002</td>
<td style="text-align: right;">0.00874644</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">114742</td>
<td style="text-align: right;">1071</td>
<td style="text-align: right;">0.00933398</td>
<td style="text-align: right;">1021.48</td>
<td style="text-align: right;">1025.8</td>
<td style="text-align: right;">1003.58</td>
<td style="text-align: right;">1025.8</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">4</td>
<td style="text-align: left;">W.16</td>
<td style="text-align: right;">150304</td>
<td style="text-align: right;">1064</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.00707899</td>
<td style="text-align: right;">0.00706169</td>
<td style="text-align: right;">0.00022846</td>
<td style="text-align: right;">0.991647</td>
<td style="text-align: right;">0.00708082</td>
<td style="text-align: right;">0.00691906</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">83039</td>
<td style="text-align: right;">510</td>
<td style="text-align: right;">0.00614169</td>
<td style="text-align: right;">586.396</td>
<td style="text-align: right;">587.984</td>
<td style="text-align: right;">574.552</td>
<td style="text-align: right;">587.832</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">5</td>
<td style="text-align: left;">AU.11</td>
<td style="text-align: right;">133445</td>
<td style="text-align: right;">1188</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.00890254</td>
<td style="text-align: right;">0.008861</td>
<td style="text-align: right;">0.000256193</td>
<td style="text-align: right;">1.0</td>
<td style="text-align: right;">0.00890254</td>
<td style="text-align: right;">0.00878751</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">70028</td>
<td style="text-align: right;">642</td>
<td style="text-align: right;">0.00916776</td>
<td style="text-align: right;">620.518</td>
<td style="text-align: right;">623.427</td>
<td style="text-align: right;">615.372</td>
<td style="text-align: right;">623.427</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">6</td>
<td style="text-align: left;">BO.38</td>
<td style="text-align: right;">125206</td>
<td style="text-align: right;">775</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0061898</td>
<td style="text-align: right;">0.00618951</td>
<td style="text-align: right;">0.000212702</td>
<td style="text-align: right;">0.846325</td>
<td style="text-align: right;">0.00636009</td>
<td style="text-align: right;">0.0061673</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">68966</td>
<td style="text-align: right;">437</td>
<td style="text-align: right;">0.00633646</td>
<td style="text-align: right;">426.865</td>
<td style="text-align: right;">438.63</td>
<td style="text-align: right;">425.334</td>
<td style="text-align: right;">426.886</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">7</td>
<td style="text-align: left;">AO.7</td>
<td style="text-align: right;">109746</td>
<td style="text-align: right;">1055</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.00961311</td>
<td style="text-align: right;">0.00955196</td>
<td style="text-align: right;">0.00030598</td>
<td style="text-align: right;">0.987444</td>
<td style="text-align: right;">0.00958404</td>
<td style="text-align: right;">0.00956317</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">59534</td>
<td style="text-align: right;">543</td>
<td style="text-align: right;">0.00912084</td>
<td style="text-align: right;">568.666</td>
<td style="text-align: right;">570.576</td>
<td style="text-align: right;">569.334</td>
<td style="text-align: right;">572.307</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">8</td>
<td style="text-align: left;">AJ.58</td>
<td style="text-align: right;">107538</td>
<td style="text-align: right;">891</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.00828544</td>
<td style="text-align: right;">0.00826232</td>
<td style="text-align: right;">0.000261736</td>
<td style="text-align: right;">0.907455</td>
<td style="text-align: right;">0.00819405</td>
<td style="text-align: right;">0.00824136</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">52176</td>
<td style="text-align: right;">394</td>
<td style="text-align: right;">0.00755136</td>
<td style="text-align: right;">431.095</td>
<td style="text-align: right;">427.533</td>
<td style="text-align: right;">430.001</td>
<td style="text-align: right;">432.301</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">9</td>
<td style="text-align: left;">AJ.52</td>
<td style="text-align: right;">107252</td>
<td style="text-align: right;">691</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.00644277</td>
<td style="text-align: right;">0.00644233</td>
<td style="text-align: right;">0.000245716</td>
<td style="text-align: right;">0.799145</td>
<td style="text-align: right;">0.00661453</td>
<td style="text-align: right;">0.00644592</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">51952</td>
<td style="text-align: right;">292</td>
<td style="text-align: right;">0.00562057</td>
<td style="text-align: right;">334.692</td>
<td style="text-align: right;">343.638</td>
<td style="text-align: right;">334.879</td>
<td style="text-align: right;">334.715</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">10</td>
<td style="text-align: left;">AJ.129</td>
<td style="text-align: right;">100824</td>
<td style="text-align: right;">693</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.00687336</td>
<td style="text-align: right;">0.00686294</td>
<td style="text-align: right;">0.000255814</td>
<td style="text-align: right;">0.8003</td>
<td style="text-align: right;">0.00695814</td>
<td style="text-align: right;">0.00685673</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">48920</td>
<td style="text-align: right;">323</td>
<td style="text-align: right;">0.00660262</td>
<td style="text-align: right;">335.735</td>
<td style="text-align: right;">340.392</td>
<td style="text-align: right;">335.431</td>
<td style="text-align: right;">336.245</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">11</td>
<td style="text-align: left;">AU.58</td>
<td style="text-align: right;">98015</td>
<td style="text-align: right;">970</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.00989644</td>
<td style="text-align: right;">0.0098265</td>
<td style="text-align: right;">0.000318572</td>
<td style="text-align: right;">0.94683</td>
<td style="text-align: right;">0.00975828</td>
<td style="text-align: right;">0.00989406</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">53424</td>
<td style="text-align: right;">508</td>
<td style="text-align: right;">0.00950883</td>
<td style="text-align: right;">524.971</td>
<td style="text-align: right;">521.326</td>
<td style="text-align: right;">528.58</td>
<td style="text-align: right;">528.708</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">12</td>
<td style="text-align: left;">X.38</td>
<td style="text-align: right;">97642</td>
<td style="text-align: right;">837</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.00857213</td>
<td style="text-align: right;">0.00853935</td>
<td style="text-align: right;">0.000314471</td>
<td style="text-align: right;">0.879527</td>
<td style="text-align: right;">0.00841862</td>
<td style="text-align: right;">0.00854678</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">49682</td>
<td style="text-align: right;">396</td>
<td style="text-align: right;">0.00797069</td>
<td style="text-align: right;">424.252</td>
<td style="text-align: right;">418.254</td>
<td style="text-align: right;">424.621</td>
<td style="text-align: right;">425.881</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">13</td>
<td style="text-align: left;">Y.34</td>
<td style="text-align: right;">92959</td>
<td style="text-align: right;">734</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.00789595</td>
<td style="text-align: right;">0.00784906</td>
<td style="text-align: right;">0.000269367</td>
<td style="text-align: right;">0.823634</td>
<td style="text-align: right;">0.00779048</td>
<td style="text-align: right;">0.00785037</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">53780</td>
<td style="text-align: right;">443</td>
<td style="text-align: right;">0.00823726</td>
<td style="text-align: right;">422.122</td>
<td style="text-align: right;">418.972</td>
<td style="text-align: right;">422.193</td>
<td style="text-align: right;">424.644</td>
</tr>
<tr class="even">
<td style="text-align: right;">⋮</td>
<td style="text-align: right;">⋮</td>
<td style="text-align: right;">⋮</td>
<td style="text-align: right;">⋮</td>
<td style="text-align: right;">⋮</td>
<td style="text-align: right;">⋮</td>
<td style="text-align: right;">⋮</td>
<td style="text-align: right;">⋮</td>
<td style="text-align: right;">⋮</td>
<td style="text-align: right;">⋮</td>
<td style="text-align: right;">⋮</td>
<td style="text-align: right;">⋮</td>
<td style="text-align: right;">⋮</td>
<td style="text-align: right;">⋮</td>
<td style="text-align: right;">⋮</td>
<td style="text-align: right;">⋮</td>
<td style="text-align: right;">⋮</td>
<td style="text-align: right;">⋮</td>
<td style="text-align: right;">⋮</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1213</td>
<td style="text-align: left;">BU.32</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.00647762</td>
<td style="text-align: right;">0.00161277</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.00647762</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1214</td>
<td style="text-align: left;">CA.5</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.00638404</td>
<td style="text-align: right;">0.00177765</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.00638404</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1215</td>
<td style="text-align: left;">D.18</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.00650955</td>
<td style="text-align: right;">0.00167563</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.00748894</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">512</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0.00390625</td>
<td style="text-align: right;">3.33289</td>
<td style="text-align: right;">3.73652</td>
<td style="text-align: right;">3.83434</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1216</td>
<td style="text-align: left;">Q.7</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.00632482</td>
<td style="text-align: right;">0.0016103</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.00748894</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.0189745</td>
<td style="text-align: right;">0.0218937</td>
<td style="text-align: right;">0.0224668</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1217</td>
<td style="text-align: left;">BW.139</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.00640492</td>
<td style="text-align: right;">0.00157165</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.00748894</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.00640492</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.00748894</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1218</td>
<td style="text-align: left;">BG.8</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.00633298</td>
<td style="text-align: right;">0.00162233</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.00748894</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">28</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.177324</td>
<td style="text-align: right;">0.204341</td>
<td style="text-align: right;">0.20969</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1219</td>
<td style="text-align: left;">R.35</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.00643966</td>
<td style="text-align: right;">0.00169121</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.00748894</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.0128793</td>
<td style="text-align: right;">0.0145958</td>
<td style="text-align: right;">0.0149779</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1220</td>
<td style="text-align: left;">I.6</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.00637603</td>
<td style="text-align: right;">0.0016485</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.00748894</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.00637603</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.00748894</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1221</td>
<td style="text-align: left;">BM.8</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.00649714</td>
<td style="text-align: right;">0.00171745</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.00748894</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.00649714</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.00748894</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1222</td>
<td style="text-align: left;">AJ.96</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.00631215</td>
<td style="text-align: right;">0.00172815</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.00631215</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1223</td>
<td style="text-align: left;">AQ.1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.00634162</td>
<td style="text-align: right;">0.00176281</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.00634162</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1224</td>
<td style="text-align: left;">AJ.118</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.00645012</td>
<td style="text-align: right;">0.00164447</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">2007</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.00645012</td>
<td style="text-align: right;">0.0072979</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: right;">0.0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="57fa3bae" class="cell" data-execution_count="10">
<pre class="julia cell-code"><code>let df = claims_summary_posterior
    f = Figure()
    ax = Axis(f[1,1],title="Cumulative Predictive Residual Error", subtitle="(Lower is better predictive accuracy)",xlabel=L"$i^{th}$ vehicle group",ylabel=L"absolute error")
    lines!(ax,cumsum(abs.(df.pred_LF .- df.claims_test)),label="Limited Fluctuation Overall",color=(:purple,0.5))
    lines!(ax,cumsum(abs.(df.pred_LF2 .- df.claims_test)),label="Limited Fluctuation Year-by-Year",color=(:blue,0.5))
    lines!(ax,cumsum(abs.(df.pred_bayes .- df.claims_test)),label="Bayesian",color=(:red,0.5))
    lines!(ax,cumsum(abs.(df.pred_naive .- df.claims_test)),label="Naive",color=(:grey10,0.5))
    # xlims!(0,40)
    # Legend(f[1,1],[s1,s2],["LFC"halign=:right,valign=:top)
    axislegend(ax,position=:rb)
    f
end</code></pre>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-11-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="ebbc5ae1" class="cell" data-execution_count="11">
<pre class="julia cell-code"><code>let 
    post = claims_summary_posterior
    X = @chain vcat(train,test) begin
        groupby(:Calendar_Year)
        @combine :claim_rate = sum(:claims) / sum(:n)
    end
    f = Figure()
    ax = Axis(f[1,1],xlabel="year",ylabel="claims rate")
    scatter!(ax,X.Calendar_Year,X.claim_rate, label="data")
    scatter!(ax,[2007],[sum(post.pred_bayes)/sum(post.n_test)], label="Bayes", marker=:hline,markersize=30)
    scatter!(ax,[2007],[sum(post.pred_LF)/sum(post.n_test)], label="LF Overall",marker=:hline,markersize=30)
    scatter!(ax,[2007],[sum(post.pred_LF2)/sum(post.n_test)], label="LF Year-by-Year",marker=:hline,markersize=30)
    scatter!(ax,[2007],[sum(post.pred_naive)/sum(post.n_test)], label="naive",marker=:hline,markersize=30)
    axislegend(ax,position=:rb)
    ylims!(0.005,0.008)
    f
end</code></pre>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-12-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="some-remarks-about-the-results" class="level2">
<h2 class="anchored" data-anchor-id="some-remarks-about-the-results">Some Remarks about the Results</h2>
<p>With limited, real-world data drawing conclusions is a little bit messy because we don’t know what the ground-truth should be, but here are some thoughts that seem to be consistent with what the data and results suggest:</p>
<ul>
<li>The Bayesian approach partially pools the data: it’s an approach in-between assuming each group is independent from the rest and assuming that a single rate applies to all exposures.</li>
<li>The partial pooling limits over-fitting, which happens with the naive approach. Our Bayesian approach is somewhat skeptical of groups with low observation counts that stand out from the rest. But it also doesn’t forgoe useful data, as it learns from even low exposures according to what’s consistent with probability theory (Baye’s rule).</li>
<li>The naive approach is pretty close to the textbook definition of over-fitting. The LF approaches appear to be under-fitting group-level as there are only $(sum(claims_summary_posterior.LF_Z_train .&gt;= .9999)) groups with “full credibility” (<code>Z=1</code>), even though there are groups with less than “full credibility” with over 100,000 observations in the training set.</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>